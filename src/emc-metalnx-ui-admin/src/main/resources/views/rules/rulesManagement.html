<!--
  ~ Copyright (c) 2015-2017, Dell EMC
  ~
  ~  Licensed under the Apache License, Version 2.0 (the "License");
  ~  you may not use this file except in compliance with the License.
  ~  You may obtain a copy of the License at
  ~
  ~  http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~  Unless required by applicable law or agreed to in writing, software
  ~  distributed under the License is distributed on an "AS IS" BASIS,
  ~  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~  See the License for the specific language governing permissions and
  ~  limitations under the License.
  -->

<html lang="en" layout:decorator="template">

<head>
    <link href="../static/css/jquery-ui.min.css" rel="stylesheet" th:href="@{/css/jquery-ui.min.css}"/>
    <script src="../static/js/jquery-1.11.4.js" th:src="@{/js/jquery-ui.min.js}"></script>
    <title th:text="#{rules.menu.title}">EMC Metalnx - Rules</title>
</head>

<body>
    <div layout:fragment="content">

        <h1 class="page-header pull-left" th:text="#{rules.menu.title}"></h1>

        <div class="row" th:unless="${unexpectedError}">
            <div class="col-xs-12" th:if="${permissionType != 'none' or user.isAdmin()}">
                <div class="row browse-collection-files-content">
                    <div id="table-loader" class="table-loader col-sm-12 hideElement">
                        <div class="panel loading">
                            <img class="center-block" th:src="@{/images/table_loading.svg}" />
                        </div>
                    </div>
                    <div class="col-xs-12">
                        <table class="table table-hover" id="treeViewTable">
                            <thead>
                            <tr>
                                <th class="tableCheckBoxCol"><input type="checkbox" name="selectAllCheckboxes" value="1" th:disabled="${currentPath == '/'}"/></th>
                                <th th:text="#{collections.management.table.collection.name.label}"></th>
                                <th th:text="#{collections.management.table.owner.label}"></th>
                                <th th:text="#{collections.management.table.kind.label}"></th>
                                <th th:text="#{collections.management.table.modified.label}"></th>
                                <th th:text="#{collections.management.table.size.label}"></th>
                            </tr>
                            </thead>
                        </table>
                    </div>
                </div>
            </div>
        </div>

    <script th:inline="javascript">
        /*<![CDATA[*/
            var url;
            var datatable;

            $(document).ready(function(e){
                datatable = $('#treeViewTable').DataTable( {
                    "serverSide": true,
                    "dom": dtPatternMlxCollections,
                    "language": i18n,
                    "destroy": true,
                    "stateSave": true,
                    "autoWidth": false,
                    "processing": true,
                    "stateSaveParams": function (settings, data) {
                        data.search.search = "";
                    },
                    "ajax": {
                        url: '/emc-metalnx-web/collections/getPaginatedJSONObjs/',
                        data: {'rulesdeployment': true}
                    },
                    "initComplete": function(settings){
                        $('#treeViewTable tbody td').each(function () {
                           $(this).attr('title', $(this).text().trim());
                        });

                        if(datatable.data().length == 0) {
                            $("#actions button").prop("disabled", true);
                            $("#actionsWait").hide();
                            $('input[name=selectAllCheckboxes]').prop("disabled", true);
                        }
                        else {
                            $('input[name=selectAllCheckboxes]').prop("disabled", false);
                            if (datatable.data().length == 1){
                                $("#treeViewTable_processing").removeClass("loading-md");
                                $("#treeViewTable_processing").removeClass("loading-sm");
                                $("#treeViewTable_processing").addClass("loading-xs");
                            }
                            else if (datatable.data().length == 2){
                                $("#treeViewTable_processing").removeClass("loading-xs");
                                $("#treeViewTable_processing").removeClass("loading-md");
                                $("#treeViewTable_processing").addClass("loading-sm");
                            }
                            else {
                                $("#treeViewTable_processing").removeClass("loading-xs");
                                $("#treeViewTable_processing").removeClass("loading-sm");
                                $("#treeViewTable_processing").addClass("loading-md");
                            }
                        }
                    },
                    "drawCallback": function(){
                        $(".dataTables_paginate.paging_simple_numbers .pagination").addClass("pagination-sm");
                        $('.dataTables_paginate.paging_simple_numbers')
                        .css( 'display', this.api().data().length <= 0 ?
                             'none' :
                             'block'
                        )
                        $('input[name=selectAllCheckboxes]').prop("checked", false);
                    },
                    "columnDefs": [
                        {
                            "render": function ( data, type, full, meta ) {
                                return '<input type="checkbox" onclick="treeViewTableItemOnClick();" name="collectionPathCheckboxes" value="'+full.path+'" id="'+full.name+'" collection="'+full.collection+'"/>';
                            },
                            "className": "dt-center",
                            "width": "25px",
                            "targets": 0,
                            "orderable": false
                        },
                        {
                            "render": function ( data, type, full, meta ) {
                                return '<a href="#" name="' + full.path +
                                    '" onclick="'+(full.collection?'getSubDirectories(\'':'getMetadata(\'')+full.path+'\')" title="' + full.path +
                                    '"><i class="'+full.iconToDisplay+'"></i>  <span>'+full.name+'</span></a>';
                            },
                            "width": "50%",
                            "targets": 1
                        },
                        {
                            "data": "owner",
                            "width": "10%",
                            "targets": 2
                        },
                        {
                            "render": function ( data, type, full, meta ){
                                return full.collection?[[#{collections.management.table.kind.collection}]]:[[#{collections.management.table.kind.dataobject}]];
                            },
                            "width": "10%",
                            "targets": 3,
                            "orderable": false
                        },
                        {
                            "data": "modifiedAtFormatted",
                            "width": "15%",
                            "targets": 4
                        },
                        {
                            "render": function ( data, type, full, meta ){
                                return full.collection? "-" : full.displaySize
                            },
                            "width": "13%",
                            "targets": 5
                        }
                    ]
                } );
                addCollectionActions('treeViewTable', datatable);
                $("input[type=checkbox]").prop("disabled", false);
            });

            $('#treeViewTable').on('page.dt', function (){
                $("#actions button").prop("disabled", true);
                $("#actionsWait").hide();
            });

            $('#treeViewTable').on( 'length.dt', function ( e, settings, len ) {
                $("#actions button").prop("disabled", true);
                $("#actionsWait").hide();
            });

            function selectAllCheckboxes() {
                $("#treeViewTable tbody input[name=collectionPathCheckboxes]").each(function(){
                    $(this).prop("checked", true);
                    $(this).parent().parent().addClass("info");
                });
            }

            $("input[type='checkbox'][name='selectAllCheckboxes']").on("change", function(){
                if($(this).is(":checked")){
                    $("#actions button").prop("disabled", true);
                    $("#actionsWait").show();
                    $('#actionLabel').html([[#{collections.management.progress.label.permissions}]]);

                    selectAllCheckboxes();
                    var paths = findPathsSelected();

                    $("#actions #modifyBtn").hide();
                    $("#actions #createTicketBtn").hide();
                }
                else {
                    $("#treeViewTable tbody input[name=collectionPathCheckboxes]").each(function(){
                        $(this).prop("checked", false);
                        $(this).parent().parent().removeClass("info");
                    });

                    $("#actions button").prop("disabled", true);
                    $("#actionsWait").hide();
                }
            });

            function treeViewTableItemOnClick() {
                var totalCheckboxesChecked = $("#treeViewTable tbody input[type=checkbox]:checked").length;
                var totalItemsDisplayed = $("#treeViewTable tbody input[type=checkbox]").length;

                $("input[name=selectAllCheckboxes]").prop("checked", totalCheckboxesChecked == totalItemsDisplayed);

                var anyCollections = $('#treeViewTable tbody input[collection="true"]:checked').length != 0;

                if(!anyCollections) $('#replicateBtn').show();
            }

        /*]]>*/
    </script>
    </div>
</body>

</html>

